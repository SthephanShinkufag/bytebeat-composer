// filters and reverb by feeshbread, pitch interpolation strategy by PrincessPriscillaPT

Y=cos,Z=tanh,t||(p1=p2=p3=p4=0,w=p=>(-Y(p/128*PI)+1)*128-.5,fx=[],dM=1e6,lp=(a,c)=>(lp_F=fxi++,fx[lp_F]??=0,fx[lp_F]+=(a-fx[lp_F])*c),hp=(a,c)=>a-lp(a,c),bp=(a,hc,lc)=>hp(lp(a,lc),hc),d=(a,hs,dw,fbfn=x=>x)=>{d_F=fxi++;fx[d_F]??=Array(dM).fill(0);d_wi=dt%dM;d_f=a;d_o=0;for(let h of hs){d_ri=(dM+dt-round(h.t))%dM;d_f+=fx[d_F][d_ri]*h.fb;d_o+=fx[d_F][d_ri]*h.m}fx[d_F][d_wi]=fbfn(d_f);return a*(1-dw)+d_o*dw}),fxi=0,dt=t,hs=[[{t:2e4+w(t/220),m:.4,fb:.15},{t:4e4+w(t/240),m:.3,fb:.35},{t:7e4+w(t/310),m:.2,fb:.45},{t:11e4+w(t/370),m:.1,fb:.65}],[{t:22e3+w(t/210),m:.4,fb:.15},{t:38e3+w(t/250),m:.3,fb:.35},{t:72e3+w(t/300),m:.2,fb:.45},{t:108e3+w(t/380),m:.1,fb:.65}]],

X=sin,ra=random,r_=round(ra()*1E6),t%r_?0:r=round(ra()*10),p_1=p1+=p2+=(PI/96*2**([1,5,6,8,10,12,13,15,17,18,20][r]/12-.5)-p2)/2E3,p_2=p3+=p4+=(PI/96*2**([1,5,6,8,10,12,13,15,17,18,20][r]/12-.5)-p4)/2E3,x=(p,lr)=>X(p*lr+Y(p/lr+X(p/lr+X(p/lr)+tan(X(p/lr))))/2)/6+X(p/lr/2)/4+lp(ra()-ra(),min(abs((lr>1?X:Y)(t/1E5/lr)),.25))*(lr>1?X:Y)(t/1E5/lr)/8,[d(x(p_1,.995,X),hs[0],.9,x=>Z(bp(x,.1,.4)/30)*40)*6,d(x(p_2,1.005,Y),hs[1],.9,x=>Z(bp(x,.1,.4)/30)*40)*6]